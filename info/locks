#!/usr/bin/env bash

ORIG_IFS=$IFS
IFS=$(echo -en "\n\b")

SCRIPT64=$(cat ./scripts/locks.sh | base64 -w 0)
echo $SCRIPT64
#SCRIPT64=IyEvdXNyL2Jpbi9lbnYgYmFzaAoKZGVjbGFyZSAtQSBuc19wb2RzCk9SSUdfSUZTPSRJRlMKSUZTPSQoZWNobyAtZW4gIlxuXGIiKQoKZm9yIGxpbmUgaW4gJChzdWRvIGxzbG9ja3MgfCBlZ3JlcCAtdiAnKHVua25vd24pJyB8IGF3ayAne3ByaW50ICQyfScgfCBzb3J0IC1uciB8IHVuaXEgLWMgfCBzb3J0IC1uciB8IGVncmVwIC12ICd1bmtub3dufC0xJyB8IGdyZXAgLXYgUElEKTsgZG8KICBjb3VudD0kKGVjaG8gJGxpbmUgfCBhd2sgJ3twcmludCAkMX0nKTsKICBwaWQ9JChlY2hvICRsaW5lIHwgYXdrICd7cHJpbnQgJDJ9Jyk7CiAgb3JpZ19waWQ9JHBpZAogIHBwaWQ9JChncmVwIFBQaWQgL3Byb2MvJHtwaWR9L3N0YXR1cyB8IGF3ayAne3ByaW50ICQyfScpCiAgd2hpbGUgW1sgJHBwaWQgLWd0IDEgXV07IGRvCiAgICBwaWQ9JHBwaWQKICAgIHBwaWQ9JChncmVwIFBQaWQgL3Byb2MvJHtwaWR9L3N0YXR1cyB8IGF3ayAne3ByaW50ICQyfScpCiAgZG9uZQogIGlmIFtbICRwcGlkIC1lcSAxIF1dOyB0aGVuCiAgICBwcGlkPSRwaWQKICBmaQogIGlmIFtbICQocHMgLWhwICRwcGlkIC1vIGNtZCB8IGdyZXAgLWMgY29ubW9uKSAtZXEgMSBdXTsgdGhlbgogICAgbnM9JChwcyAtaHAgJHBwaWQgLW8gY21kIHwgZ3JlcCBjb25tb24gfCBhd2sgJ3twcmludCAkOX0nIHwgYXdrIC1GLyAne3ByaW50ICQ1fScgfCBhd2sgLUZfICd7cHJpbnQgJDF9JykKICAgIHBvZD0kKHBzIC1ocCAkcHBpZCAtbyBjbWQgfCBncmVwIGNvbm1vbiB8IGF3ayAne3ByaW50ICQ5fScgfCBhd2sgLUYvICd7cHJpbnQgJDV9JyB8IGF3ayAtRl8gJ3twcmludCAkMn0nKQogICAgaWYgWyAke25zX3BvZHNbIiR7bnN9LyR7cG9kfSJdfSBdOyB0aGVuCiAgICAgIG5zX3BvZHNbIiR7bnN9LyR7cG9kfSJdPWBleHByICR7bnNfcG9kc1siJHtuc30vJHtwb2R9Il19ICsgJGNvdW50YAogICAgZWxzZQogICAgICBuc19wb2RzWyIke25zfS8ke3BvZH0iXT0kY291bnQKICAgIGZpCiAgZmkKZG9uZQpmb3IgcG9kIGluICIkeyFuc19wb2RzW0BdfSI7IGRvCiAgZWNobyAkcG9kICR7bnNfcG9kc1skcG9kXX0KZG9uZSB8IHNvcnQgLW5yIC1rMiB8IGNvbHVtbiAtdCAKCklGUz0kT1JJR19JRlMK

[ -z ${UTILSFILE} ] && source $(echo "$(dirname ${0})/../utils")
if oc auth can-i debug node >/dev/null 2>&1; then
  msg "Checking for locks by pod, per node (${BLUE}using oc debug, it can take a while${NOCOLOR})"
    fw_errors=0
  # shellcheck disable=SC2016
  for node in $(oc get nodes -o go-template='{{range .items}}{{$node := .}}{{range .status.conditions}}{{if eq .type "Ready"}}{{if eq .status "True"}}node/{{$node.metadata.name}}{{"\n"}}{{end}}{{end}}{{end}}{{end}}'); do
    # shellcheck disable=SC1083
    if ! FILE_LOCKS=$(oc debug --image="${OCDEBUGIMAGE}" "${node}" -- chroot /host sh -c "echo $SCRIPT64 | base64 -d > /tmp/locks.sh; chmod 755 /tmp/locks.sh; /tmp/locks.sh; rm -f /tmp/locks.sh"); then
      msg "${ORANGE}Error running oc debug in ${node}${NOCOLOR}"
    else
      if [ -n "${FILE_LOCKS}" ]; then
            msg "File locks found on on ${RED}${node}${NOCOLOR}"
            for line in ${FILE_LOCKS}; do
              echo $line
            done
      else
        msg "Couldn't check for locks on ${node}"
      fi
    fi
  done
  exit ${OCINFO}
else
  msg "Couldn't debug nodes, check permissions"
  exit ${OCSKIP}
fi
exit ${OCUNKOWN}
